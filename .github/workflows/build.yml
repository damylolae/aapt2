name: Build aapt2

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: read

    strategy:
      matrix:
        target: [x86_64, i686, aarch64, armv7a]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install NDK r27 (latest stable as of 2025)
        uses: nttld/setup-ndk@v1
        id: ndk
        with:
          ndk-version: r27
          add-to-path: false

      - name: Setup toolchain variables
        run: |
          NDK_ROOT="${{ steps.ndk.outputs.ndk-path }}"
          TOOLCHAIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64"

          case ${{ matrix.target }} in
            x86_64)   TRIPLE=x86_64-linux-android21  ; API=21 ;;
            i686)     TRIPLE=i686-linux-android16    ; API=16 ;;
            aarch64)  TRIPLE=aarch64-linux-android21 ; API=21 ;;
            armv7a)   TRIPLE=armv7a-linux-androideabi16 ; API=16 ;;
          esac

          cat <<EOF >> $GITHUB_ENV
CC=\( {TOOLCHAIN}/bin/ \){TRIPLE}-clang
CXX=\( {TOOLCHAIN}/bin/ \){TRIPLE}-clang++
AR=${TOOLCHAIN}/bin/llvm-ar
AS=${TOOLCHAIN}/bin/llvm-as
LD=${TOOLCHAIN}/bin/ld.lld
RANLIB=${TOOLCHAIN}/bin/llvm-ranlib
STRIP=${TOOLCHAIN}/bin/llvm-strip
NDK_TOOLCHAIN=${TOOLCHAIN}
ANDROID_NDK_ROOT=${NDK_ROOT}
ANDROID_API=${API}
TARGET=${TRIPLE}
EOF

          echo "Building \( {{ matrix.target }} â†’ \){TRIPLE} (API $API)"

      - name: Build aapt2 (with full control over environment)
        run: |
          mkdir -p dist/${{ matrix.target }}

          # Force correct flags for autotools and CMake
          export CFLAGS="-O3 -fPIE"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-pie -Wl,--gc-sections"

          ./build.sh \( {{ matrix.target }} dist/ \){{ matrix.target }}

      - name: Attest provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: dist/${{ matrix.target }}/*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aapt2-${{ matrix.target }}
          path: dist/${{ matrix.target }}/*
          if-no-files-found: error
