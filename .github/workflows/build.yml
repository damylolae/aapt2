name: Build aapt2

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Reason for manual run'
        required: false
        default: 'Manual build'

jobs:
  build:
    name: Build aapt2 ${{ matrix.target_arch }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write          # needed for OIDC
      attestations: write      # needed for provenance attestation
      contents: read

    strategy:
      matrix:
        target_arch: [x86_64, i686, aarch64, armv7a]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Android NDK r23c
        uses: nttld/setup-ndk@v1
        id: ndk
        with:
          ndk-version: r23c
          add-to-path: false

      - name: Configure toolchain and environment
        run: |
          NDK_PATH="${{ steps.ndk.outputs.ndk-path }}"
          TOOLCHAIN_PATH="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64"

          case ${{ matrix.target_arch }} in
            x86_64)
              CLANG_TRIPLE=x86_64-linux-android21
              MIN_API=21
              ;;
            i686)
              CLANG_TRIPLE=i686-linux-android16
              MIN_API=16
              ;;
            aarch64)
              CLANG_TRIPLE=aarch64-linux-android21
              MIN_API=21
              ;;
            armv7a)
              CLANG_TRIPLE=armv7a-linux-androideabi16
              MIN_API=16
              ;;
          esac

          echo "CC=\( TOOLCHAIN_PATH/bin/ \){CLANG_TRIPLE}-clang" >> $GITHUB_ENV
          echo "CXX=\( TOOLCHAIN_PATH/bin/ \){CLANG_TRIPLE}-clang++" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN=$TOOLCHAIN_PATH" >> $GITHUB_ENV
          echo "ANDROID_PAGE_SIZE=16384" >> $GITHUB_ENV
          echo "TARGET_ARCH=${{ matrix.target_arch }}" >> $GITHUB_ENV

          # Debug output
          echo "Target: ${{ matrix.target_arch }} â†’ $CLANG_TRIPLE (API $MIN_API)"

      - name: Build aapt2
        run: |
          echo "Building aapt2 for ${{ matrix.target_arch }}..."
          mkdir -p dist/${{ matrix.target_arch }}
          ./build.sh \( {{ matrix.target_arch }} dist/ \){{ matrix.target_arch }}

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: dist/${{ matrix.target_arch }}/*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aapt2-${{ matrix.target_arch }}
          path: dist/${{ matrix.target_arch }}/*
          if-no-files-found: error
